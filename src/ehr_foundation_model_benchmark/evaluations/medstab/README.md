# MEDS-TAB

This folder contains the code for meds-tab evaluation. It contains a lot of helper scripts to work around the existing meds-tab issues.

## Installation

```
conda create --name medstab
conda activate medstab
conda install python==3.11.*
pip install meds_tab-0.1.dev478+g74f80c3-py3-none-any.whl
pip install meds_evaluation-0.1.dev95+g841c87f-py3-none-any.whl
```

## Meds-tab folders

Meds-tab requires many folders to work, and they have been all replaced by special tokens for anonymization:
- meds-tab data path `XX1`
- meds-tab task labels non-sharded path `XX2`
- meds-tab task labels sharded path `XX3`
- meds-tab featurization path `XX4`
- meds-tab label-aligned featurization path `XX5` (only for all caching strategy, that has not been used for our experiments)
- meds-tab featurization path `XX6` for subsampled datasets
- results folder `XX7`

## Scripts

Main pipeline (**make sure to edit the paths first in the headers of these files**) to generate the results in `XX7`:
- `featurization/run_medstab_patient_large.py` to run the featurization for the patient tasks `readmission`, `long_los` and `death/mortality`, as well as training the xgboost model with all samples.
- `featurization/run_medstab_pheno_large.py` to run the featurization for the phenotype tasks `AMI`, `CLL`, `Celiac`, `HTN`, `Ischemic_Stroke`, `MASLD`, `Osteoporosis`, `Pancreatic Cancer`, `Schizophrenia`, `SLE`, `T2DM`, as well as training the xgboost model with all samples.
- `xgb/auto_sweep.py` to run xgboost models on 100, 1000, and 10000 samples
- `postprocessing/bootstrap.py` to export the xgboost results
- `lr/linear_prob-lr.py` to run logistic regressions for 100, 1000, 10k and 100k (all) samples
- `postprocessing/bootstrap-linear.py` to export the lr results

Please note that on our data, for one task, with 64 cores, meds-tab featurization consume 500 GB RAM and takes about 12 hours.

## Additional details

Scripts called by the main scripts:
- `preprocessing/reshard.py` to reshard labels data to match the sharding of the meds data
- `post_processing/extract_features.py` to extract meds-tab features as a single file with label information
- `xgb/linear_prob-xgboost.py` to subsample splits for xgboost training
- `xgb/select_features.py` to rebuild a medstab compatible feature folder with a subsampled dataset
- `lr/linear_prob.py` to subsample splits for lr training

Helpers:
- `debug/progress.sh` to keep track of the current progress of featurization and get a remaining time estimate.
- `debug/clean_cache.py` to manually clean locks after meds-tab crashes.
- `debug/clean.sh` to manually kill all Python processes after meds-tab crashes. They can be obtained and saved to a file with `ps -u user -o pid,comm,etime,%cpu,%mem,args --sort=-%cpu > processes.txt`

Diagnostics:
- `debug/run_medstab_patient.py` is a script to run medstab on a sample dataset to debug and compare all caching and task specific featurization
- `debug/label_check.py` is a a script to compare the features generated by all caching and task specific featurization

## Troubleshooting

- try xgboost-cpu instead of xgboost
```
pip uninstall xgboost
pip install xgboost-cpu
```